# 詳細設計（ドラフト）

---

## 1. n8nワークフロー設計

### 1-1. X投稿取得フロー
- **トリガー**：定期実行（Cron）
- **処理**：
  1. X API（公式）で指定ユーザの新規投稿を取得
  2. 取得済みX投稿IDリストと突合し、未保存分のみ抽出
  3. Notion APIでデータベースに新規レコード追加
  4. エラー時はSlackの特定チャネル/メールで通知

### 1-2. AI分析・チャット応答フロー
- **トリガー**：Slack/LINEメッセージ受信時
- **処理**：
  1. メッセージ内容を受信
  2. Notion DBから関連投稿を検索・抽出
  3. 必要に応じてPythonスクリプトで前処理
  4. AI API（OpenAI等）に問い合わせ・要約/分析
  5. 結果をSlack/LINEに返信

### 1-3. 管理・監視フロー
- **トリガー**：各種エラー発生時
- **処理**：Slackの特定チャネルに通知、ログ保存

---

## 2. Laravel管理UI/API設計

> **前提：Notionアカウント・データベースは固定（個人利用）**
> - Notion DBの切替やユーザ情報の登録・編集機能は不要
> - 設定ファイル（.env等）でアクセストークン・DB IDを管理

### 2-1. 投稿・履歴閲覧画面
- 取得済みX投稿の一覧・検索（Notion DBから取得）
- AI応答履歴の一覧・検索

### 2-2. API/Webhook
- n8nやPythonスクリプトから呼び出せるWebhook/APIエンドポイント
- 認証・権限管理

---

## 3. Notionデータベース詳細スキーマ

| カラム名     | 型         | 必須 | 説明                       |
|--------------|------------|------|----------------------------|
| 投稿日付     | Date       | ○    | X投稿の日時                |
| 投稿内容     | Text       | ○    | 本文                       |
| リプライ情報 | Text/JSON  |      | リプライ先・内容           |
| RT情報       | Number/Text|      | RT数・元投稿情報           |
| 画像         | URL/Files  |      | メディアURL                |
| 返信情報     | Text/JSON  |      | 返信先・内容               |
| X投稿ID      | Text       | ○    | 一意なID（重複防止用）     |
| 投稿URL      | URL        | ○    | X上の投稿URL               |
| 取得日時     | DateTime   | ○    | システムが取得した日時      |

---

## 4. AI連携設計

- **AI API**：OpenAI GPT-3.5（コスト重視、APIキーは.env管理）
- **プロンプト例**：
  - 「過去1週間の投稿内容を要約してください」
  - 「○○に関する投稿を抽出し、傾向を教えてください」
- **前処理**：長文分割、不要情報除去などはPythonスクリプトで対応
- **n8nからAI API呼び出し→結果をSlack/LINEに返却**

---

## 5. 運用・セキュリティ詳細

- Notionアカウント・DBは固定、アクセストークン・DB IDは.envで管理
- n8n/Laravel/PythonはDocker Compose等で分離運用
- バックアップ・ログローテーション設計
- エラー・例外時はSlackの特定チャネルに即時通知
- データの外部公開は禁止

---

> 本ドキュメントは随時アップデートします。ご質問・追加要望があればご指示ください。 